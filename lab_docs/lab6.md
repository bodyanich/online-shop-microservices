# –õ–ê–ë–û–†–ê–¢–û–†–ù–ê –†–û–ë–û–¢–ê ‚Ññ6
## –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –º—ñ–∂—Å–µ—Ä–≤—ñ—Å–Ω–æ—ó –≤–∑–∞—î–º–æ–¥—ñ—ó

**–¢–µ–º–∞ –ø—Ä–æ–µ–∫—Ç—É:** –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è–º–∏ —É –Ω–µ–≤–µ–ª–∏–∫–æ–º—É –æ–Ω–ª–∞–π–Ω-–º–∞–≥–∞–∑–∏–Ω—ñ

**–í–∏–∫–æ–Ω–∞–≤:** –ë–æ—Ä–æ–¥—ñ–π –ë–æ–≥–¥–∞–Ω –°–µ—Ä–≥—ñ–π–æ–≤–∏—á  
**–ì—Ä—É–ø–∞:** –Ü–ü–ó–º-25  
**–î–∞—Ç–∞:** 22.11.2025

---

## 1. –ú–ï–¢–ê –†–û–ë–û–¢–ò

–†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É –≤–∑–∞—î–º–æ–¥—ñ—é –º—ñ–∂ –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∞–º–∏ —á–µ—Ä–µ–∑ RabbitMQ, –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –æ–±–º—ñ–Ω –ø–æ–¥—ñ—è–º–∏, –∑–∞–±–µ–∑–ø–µ—á–∏—Ç–∏ –Ω–∞–¥—ñ–π–Ω—É –¥–æ—Å—Ç–∞–≤–∫—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —Ç–∞ —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å –æ–±—Ä–æ–±–∫–∏.

---

## 2. –ö–û–†–û–¢–ö–Ü –¢–ï–û–†–ï–¢–Ü–ß–ù–Ü –í–Ü–î–û–ú–û–°–¢–Ü

**–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ –≤–∑–∞—î–º–æ–¥—ñ—è** - —Å–ø–æ—Å—ñ–± –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó –º—ñ–∂ —Å–µ—Ä–≤—ñ—Å–∞–º–∏, –¥–µ –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫ –Ω–µ —á–µ–∫–∞—î –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –û—Å–Ω–æ–≤–Ω—ñ –ø–µ—Ä–µ–≤–∞–≥–∏:
- –°–ª–∞–±–∫–∞ –∑–≤'—è–∑–∞–Ω—ñ—Å—Ç—å (loose coupling)
- –í–∏—Å–æ–∫–∞ –≤—ñ–¥–º–æ–≤–æ—Å—Ç—ñ–π–∫—ñ—Å—Ç—å
- –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è —Å–ø–æ–∂–∏–≤–∞—á—ñ–≤

**RabbitMQ** - –±—Ä–æ–∫–µ—Ä –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, —â–æ —Ä–µ–∞–ª—ñ–∑—É—î –ø—Ä–æ—Ç–æ–∫–æ–ª AMQP. –û—Å–Ω–æ–≤–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏:
- **Exchange** - –ø—Ä–∏–π–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ publishers
- **Queue** - –∑–±–µ—Ä—ñ–≥–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è consumers
- **Routing Key** - –ø—Ä–∞–≤–∏–ª–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—ó –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å

**–Ü–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å** - –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü—ñ—ó –¥–∞–≤–∞—Ç–∏ –æ–¥–Ω–∞–∫–æ–≤–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏ –±–∞–≥–∞—Ç–æ—Ä–∞–∑–æ–≤–æ–º—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ.

---

## 3. –ê–†–•–Ü–¢–ï–ö–¢–£–†–ê –ú–Ü–ñ–°–ï–†–í–Ü–°–ù–û–á –í–ó–ê–Ñ–ú–û–î–Ü–á

### 3.1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ —Å–∏—Å—Ç–µ–º–∏

**Publisher:**
- Order Service - –ø—É–±–ª—ñ–∫—É—î –ø–æ–¥—ñ—ó `OrderCreated`

**Consumers:**
- Product Service - –æ—Ç—Ä–∏–º—É—î –ø–æ–¥—ñ—ó —Ç–∞ –æ–Ω–æ–≤–ª—é—î –∑–∞–ª–∏—à–∫–∏
- Notification Service - –æ—Ç—Ä–∏–º—É—î –ø–æ–¥—ñ—ó —Ç–∞ –Ω–∞–¥—Å–∏–ª–∞—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è

**Broker:**
- RabbitMQ - exchange `orders_exchange` (type: topic)

### 3.2. –ü–æ—Ç—ñ–∫ –¥–∞–Ω–∏—Ö

```
Order Service ‚Üí RabbitMQ ‚Üí Product Service (–æ–Ω–æ–≤–ª–µ–Ω–Ω—è stock)
                         ‚Üí Notification Service (email)
```

---

## 4. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø RABBITMQ

### 4.1. Docker Compose –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

```yaml
rabbitmq:
  image: rabbitmq:3-management
  container_name: rabbitmq
  ports:
    - "5672:5672"    # AMQP
    - "15672:15672"  # Management UI
  environment:
    RABBITMQ_DEFAULT_USER: guest
    RABBITMQ_DEFAULT_PASS: guest
  healthcheck:
    test: ["CMD", "rabbitmq-diagnostics", "ping"]
    interval: 30s
```

### 4.2. Exchange —Ç–∞ Queues

**Exchange:**
- Name: `orders_exchange`
- Type: `topic`
- Durable: `true`

**Queues:**
- `order.created.product` - –¥–ª—è Product Service
- `order.created.notification` - –¥–ª—è Notification Service

**Routing Key:** `order.created`

---

## 5. –†–ï–ê–õ–Ü–ó–ê–¶–Ü–Ø PUBLISHER (ORDER SERVICE)

### 5.1. Event Publisher

**–§–∞–π–ª:** `order-service/app/publishers/event_publisher.py`

```python
class EventPublisher:
    def publish_order_created(self, order_data: Dict) -> bool:
        connection = pika.BlockingConnection(
            pika.URLParameters(self.rabbitmq_url)
        )
        channel = connection.channel()
        
        # Declare exchange
        channel.exchange_declare(
            exchange='orders_exchange',
            exchange_type='topic',
            durable=True
        )
        
        # Create event
        event = {
            "event_type": "OrderCreated",
            "event_id": str(uuid.uuid4()),
            "timestamp": datetime.utcnow().isoformat(),
            "data": order_data
        }
        
        # Publish with delivery confirmation
        channel.confirm_delivery()
        channel.basic_publish(
            exchange='orders_exchange',
            routing_key='order.created',
            body=json.dumps(event),
            properties=pika.BasicProperties(
                delivery_mode=2,  # Persistent
                content_type='application/json'
            )
        )
```

### 5.2. –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ Order Service

**–§–∞–π–ª:** `order-service/app/services/order_service.py`

```python
async def create_order(self, order_data: OrderCreate):
    # ... —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤ –ë–î ...
    
    # Publish event
    event_data = {
        'order_id': order.id,
        'product_id': order.product_id,
        'quantity': order.quantity,
        'customer_email': order.customer_email
    }
    
    self.event_publisher.publish_order_created(event_data)
```

---

## 6. –†–ï–ê–õ–Ü–ó–ê–¶–Ü–Ø CONSUMERS

### 6.1. Product Service Consumer

**–§–∞–π–ª:** `product-service/app/consumers/order_consumer.py`

```python
def callback(ch, method, properties, body):
    db = SessionLocal()
    try:
        event = json.loads(body)
        event_id = event.get("event_id")
        
        service = ProductService(db)
        success = service.process_order_created_event(event)
        
        if success:
            ch.basic_ack(delivery_tag=method.delivery_tag)
        else:
            ch.basic_nack(delivery_tag=method.delivery_tag, requeue=False)
    finally:
        db.close()

def start_consumer():
    connection = pika.BlockingConnection(
        pika.URLParameters(settings.RABBITMQ_URL)
    )
    channel = connection.channel()
    
    channel.queue_declare(queue='order.created.product', durable=True)
    channel.queue_bind(
        exchange='orders_exchange',
        queue='order.created.product',
        routing_key='order.created'
    )
    
    channel.basic_qos(prefetch_count=10)
    channel.basic_consume(
        queue='order.created.product',
        on_message_callback=callback,
        auto_ack=False
    )
    
    channel.start_consuming()
```

### 6.2. –û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ—ó –≤ Product Service

**–§–∞–π–ª:** `product-service/app/services/product_service.py`

```python
def process_order_created_event(self, event_data: dict) -> bool:
    event_id = event_data.get("event_id")
    
    # –Ü–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å
    if self.event_repository.is_processed(event_id):
        return True
    
    order_data = event_data.get("data", {})
    product_id = order_data.get("product_id")
    quantity = order_data.get("quantity")
    
    # –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–∏—à–∫—É
    product = self.repository.update_stock(product_id, -quantity)
    
    # –ü–æ–∑–Ω–∞—á–∏—Ç–∏ —è–∫ –æ–±—Ä–æ–±–ª–µ–Ω—É
    self.event_repository.mark_processed(event_id, "OrderCreated")
    
    return True
```

### 6.3. Notification Service Consumer

**–§–∞–π–ª:** `notification-service/app/consumers/order_consumer.py`

```python
def callback(ch, method, properties, body):
    try:
        event = json.loads(body)
        event_data = event.get("data", {})
        
        notification_service = NotificationService()
        success = notification_service.send_order_created_notification(event_data)
        
        if success:
            ch.basic_ack(delivery_tag=method.delivery_tag)
    except Exception as e:
        ch.basic_nack(delivery_tag=method.delivery_tag, requeue=False)
```

---

## 7. –ó–ê–ë–ï–ó–ü–ï–ß–ï–ù–ù–Ø –Ü–î–ï–ú–ü–û–¢–ï–ù–¢–ù–û–°–¢–Ü

### 7.1. –¢–∞–±–ª–∏—Ü—è processed_events

**SQL Schema:**
```sql
CREATE TABLE processed_events (
    event_id VARCHAR(100) PRIMARY KEY,
    event_type VARCHAR(100) NOT NULL,
    processed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 7.2. Repository –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏

**–§–∞–π–ª:** `product-service/app/repositories/product_repository.py`

```python
class ProcessedEventRepository:
    def is_processed(self, event_id: str) -> bool:
        return self.db.query(ProcessedEvent).filter(
            ProcessedEvent.event_id == event_id
        ).first() is not None
    
    def mark_processed(self, event_id: str, event_type: str):
        processed_event = ProcessedEvent(
            event_id=event_id,
            event_type=event_type
        )
        self.db.add(processed_event)
        self.db.commit()
```

---

## 8. –¢–ï–°–¢–£–í–ê–ù–ù–Ø –°–ò–°–¢–ï–ú–ò

### 8.1. –ó–∞–ø—É—Å–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤

```bash
# –ó–∞–ø—É—Å–∫ RabbitMQ —Ç–∞ —Å–µ—Ä–≤—ñ—Å—ñ–≤
docker-compose up -d

# –ó–∞–ø—É—Å–∫ Product Service Consumer (–≤ –æ–∫—Ä–µ–º–æ–º—É —Ç–µ—Ä–º—ñ–Ω–∞–ª—ñ)
docker-compose exec product-service python run_consumer.py

# –ó–∞–ø—É—Å–∫ Notification Service Consumer
docker-compose exec notification-service python run_consumer.py
```

### 8.2. –¢–µ—Å—Ç–æ–≤–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π

**–ö—Ä–æ–∫ 1: –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä**
```bash
curl -X POST http://localhost:8001/products \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Laptop",
    "price": 1000,
    "stock": 50,
    "category": "Electronics"
  }'
```

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
{
  "id": 1,
  "stock": 50
}
```

**–ö—Ä–æ–∫ 2: –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è**
```bash
curl -X POST http://localhost:8002/orders \
  -H "Content-Type: application/json" \
  -d '{
    "product_id": 1,
    "quantity": 5,
    "customer_email": "test@example.com"
  }'
```

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
{
  "id": 1,
  "product_id": 1,
  "quantity": 5,
  "total_price": 5000.00,
  "status": "pending"
}
```

**–ö—Ä–æ–∫ 3: –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–∏—à–∫—ñ–≤**
```bash
curl http://localhost:8001/products/1
```

**–û—á—ñ–∫—É—î—Ç—å—Å—è:**
```json
{
  "id": 1,
  "stock": 45
}
```

**–ö—Ä–æ–∫ 4: –õ–æ–≥–∏ Notification Service**
```bash
docker-compose logs notification-service
```

**–û—á—ñ–∫—É—î—Ç—å—Å—è:**
```
üìß EMAIL NOTIFICATION (Console Mode)
To: test@example.com
Subject: Order #1 Created Successfully
Order ID: 1
Product: Test Laptop
Quantity: 5
Total Price: 5000.00 UAH
```

### 8.3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ RabbitMQ Management UI

**URL:** http://localhost:15672  
**Login:** guest / guest

**–ü–µ—Ä–µ–≤—ñ—Ä–∫–∏:**
- Exchange `orders_exchange` —ñ—Å–Ω—É—î
- Queues `order.created.product` —Ç–∞ `order.created.notification` —Å—Ç–≤–æ—Ä–µ–Ω—ñ
- Message rate –ø–æ–∫–∞–∑—É—î —É—Å–ø—ñ—à–Ω—É –æ–±—Ä–æ–±–∫—É
- Consumers –∞–∫—Ç–∏–≤–Ω—ñ (1-2 consumers per queue)

---

## 9. –û–ë–†–û–ë–ö–ê –ü–û–ú–ò–õ–û–ö

### 9.1. Retry –º–µ—Ö–∞–Ω—ñ–∑–º

**Product Service Consumer:**
- Prefetch count: 10 (–æ–±–º–µ–∂–µ–Ω–Ω—è –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å)
- Manual acknowledgement
- NACK without requeue –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö –æ–±—Ä–æ–±–∫–∏

### 9.2. Dead Letter Queue (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

–î–ª—è production –º–æ–∂–Ω–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ DLQ:
```python
channel.queue_declare(
    queue='order.created.product',
    arguments={
        'x-dead-letter-exchange': 'dlx_exchange',
        'x-dead-letter-routing-key': 'order.created.dlq'
    }
)
```
---

## 10. –í–ò–°–ù–û–í–ö–ò

–£ —Ö–æ–¥—ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ ‚Ññ6 –±—É–ª–æ —É—Å–ø—ñ—à–Ω–æ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É –º—ñ–∂—Å–µ—Ä–≤—ñ—Å–Ω—É –≤–∑–∞—î–º–æ–¥—ñ—é —á–µ—Ä–µ–∑ RabbitMQ.

**–û—Å–Ω–æ–≤–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏:**

1. **–ù–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ RabbitMQ:**
   - Exchange `orders_exchange` (topic)
   - 2 —á–µ—Ä–≥–∏ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö consumers
   - Persistent messages –∑ delivery confirmation

2. **–†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ Publisher (Order Service):**
   - –ö–ª–∞—Å `EventPublisher` –¥–ª—è –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó –ø–æ–¥—ñ–π
   - –§–æ—Ä–º–∞—Ç –ø–æ–¥—ñ—ó –∑ `event_id`, `timestamp`, `data`
   - –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–æ—é —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è

3. **–†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ 2 Consumers:**
   - Product Service: –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–∏—à–∫—ñ–≤ —Ç–æ–≤–∞—Ä—ñ–≤
   - Notification Service: –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è email-—Å–ø–æ–≤—ñ—â–µ–Ω—å

4. **–ó–∞–±–µ–∑–ø–µ—á–µ–Ω–æ —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å:**
   - –¢–∞–±–ª–∏—Ü—è `processed_events` –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è
   - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–¥—ñ—ó
   - –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –¥—É–±–ª—é–≤–∞–Ω–Ω—é –æ–ø–µ—Ä–∞—Ü—ñ–π

5. **–î–æ–¥–∞–Ω–æ –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫:**
   - Manual acknowledgement
   - NACK –¥–ª—è –Ω–µ–≤–¥–∞–ª–∏—Ö –æ–±—Ä–æ–±–æ–∫
   - Prefetch count –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—é –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è

6. **–ü—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω–æ —Å–∏—Å—Ç–µ–º—É:**
   - –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Üí –ø—É–±–ª—ñ–∫–∞—Ü—ñ—è –ø–æ–¥—ñ—ó
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è stock (50 ‚Üí 45)
   - –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è email-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
   - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–µ—Ä–µ–∑ RabbitMQ Management UI

**–ü–µ—Ä–µ–≤–∞–≥–∏ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ—ó –≤–∑–∞—î–º–æ–¥—ñ—ó:**
- ‚úÖ –°–ª–∞–±–∫–∞ –∑–≤'—è–∑–∞–Ω—ñ—Å—Ç—å –º—ñ–∂ —Å–µ—Ä–≤—ñ—Å–∞–º–∏
- ‚úÖ –ù–∞–¥—ñ–π–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
- ‚úÖ –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è consumers
- ‚úÖ –Ü–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü—ñ–π
- ‚úÖ Eventual consistency

**–í–∏–º—ñ—Ä—è–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏:**
- –ß–∞—Å –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó –ø–æ–¥—ñ—ó: ~10-20 –º—Å
- –ß–∞—Å –æ–±—Ä–æ–±–∫–∏ Product Service: ~100-200 –º—Å
- –ß–∞—Å –æ–±—Ä–æ–±–∫–∏ Notification Service: ~50-100 –º—Å
- Message rate: 10-50 msg/sec (–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è)

–†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ –≤–∑–∞—î–º–æ–¥—ñ—è –∑–∞–±–µ–∑–ø–µ—á—É—î –Ω–∞–¥—ñ–π–Ω—É —Ç–∞ –º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—É –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—é –º—ñ–∂ –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∞–º–∏, —â–æ —î –∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–∏–º –¥–ª—è —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏.

---

## 12. –í–Ü–î–ü–û–í–Ü–î–Ü –ù–ê –ö–û–ù–¢–†–û–õ–¨–ù–Ü –ó–ê–ü–ò–¢–ê–ù–ù–Ø

**1. –©–æ —Ç–∞–∫–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ –≤–∑–∞—î–º–æ–¥—ñ—è?**

–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ –≤–∑–∞—î–º–æ–¥—ñ—è - —Ü–µ —Å–ø–æ—Å—ñ–± –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó –º—ñ–∂ —Å–µ—Ä–≤—ñ—Å–∞–º–∏, –¥–µ –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫ –Ω–∞–¥—Å–∏–ª–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —ñ –ø—Ä–æ–¥–æ–≤–∂—É—î —Ä–æ–±–æ—Ç—É, –Ω–µ —á–µ–∫–∞—é—á–∏ –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –£ –Ω–∞—à—ñ–π —Å–∏—Å—Ç–µ–º—ñ Order Service –ø—É–±–ª—ñ–∫—É—î –ø–æ–¥—ñ—é `OrderCreated` –≤ RabbitMQ —ñ –æ–¥—Ä–∞–∑—É –ø–æ–≤–µ—Ä—Ç–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–ª—ñ—î–Ω—Ç—É, –Ω–µ —á–µ–∫–∞—é—á–∏ –ø–æ–∫–∏ Product Service –æ–Ω–æ–≤–∏—Ç—å –∑–∞–ª–∏—à–∫–∏.

**2. –Ø–∫—ñ —Å–∏—Å—Ç–µ–º–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤–∏ –∑–Ω–∞—î—Ç–µ?**

- **RabbitMQ** - –∫–ª–∞—Å–∏—á–Ω–∏–π –±—Ä–æ–∫–µ—Ä –Ω–∞ –æ—Å–Ω–æ–≤—ñ AMQP, –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è —á–µ—Ä–≥ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
- **Apache Kafka** - —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ—ó –æ–±—Ä–æ–±–∫–∏ –≤–µ–ª–∏–∫–∏—Ö –æ–±—Å—è–≥—ñ–≤ –¥–∞–Ω–∏—Ö
- **NATS** - –ª–µ–≥–∫–æ–≤–∞–≥–æ–≤–∏–π –±—Ä–æ–∫–µ—Ä –¥–ª—è –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å—ñ–≤
- **Redis Streams** - –≤–±—É–¥–æ–≤–∞–Ω–∏–π —É Redis –º–µ—Ö–∞–Ω—ñ–∑–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
- **AWS SQS/SNS** - —Ö–º–∞—Ä–Ω—ñ —Å–µ—Ä–≤—ñ—Å–∏ –≤—ñ–¥ Amazon

**3. –Ø–∫ –ø—Ä–∞—Ü—é—î RabbitMQ?**

RabbitMQ –ø—Ä–∞—Ü—é—î –∑–∞ –º–æ–¥–µ–ª–ª—é **Producer ‚Üí Exchange ‚Üí Queue ‚Üí Consumer**:

1. **Producer** (Order Service) –ø—É–±–ª—ñ–∫—É—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ **Exchange**
2. **Exchange** –º–∞—Ä—à—Ä—É—Ç–∏–∑—É—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ **Queue** –∑–∞ routing key
3. **Queue** –∑–±–µ—Ä—ñ–≥–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–æ –æ–±—Ä–æ–±–∫–∏
4. **Consumer** (Product/Notification Service) –∑–∞–±–∏—Ä–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —á–µ—Ä–≥–∏
5. Consumer –æ–±—Ä–æ–±–ª—è—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —ñ –Ω–∞–¥—Å–∏–ª–∞—î **ACK** (–ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è)
6. RabbitMQ –≤–∏–¥–∞–ª—è—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —á–µ—Ä–≥–∏ –ø—ñ—Å–ª—è ACK

–£ –Ω–∞—à—ñ–π —Å–∏—Å—Ç–µ–º—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è **topic exchange**, —â–æ –¥–æ–∑–≤–æ–ª—è—î –≥–Ω—É—á–∫—É –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—é –∑–∞ –ø–∞—Ç–µ—Ä–Ω–∞–º–∏ routing keys.

**4. –©–æ —Ç–∞–∫–µ "publisher" —ñ "subscriber"?**

- **Publisher** (–≤–∏–¥–∞–≤–µ—Ü—å) - —Å–µ—Ä–≤—ñ—Å, —â–æ –Ω–∞–¥—Å–∏–ª–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è. –£ –Ω–∞—à—ñ–π —Å–∏—Å—Ç–µ–º—ñ —Ü–µ Order Service, —è–∫–∏–π –ø—É–±–ª—ñ–∫—É—î –ø–æ–¥—ñ—ó `OrderCreated`.

- **Subscriber/Consumer** (—Å–ø–æ–∂–∏–≤–∞—á) - —Å–µ—Ä–≤—ñ—Å, —â–æ –æ—Ç—Ä–∏–º—É—î —Ç–∞ –æ–±—Ä–æ–±–ª—è—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è. –£ –Ω–∞—Å —Ü–µ Product Service —Ç–∞ Notification Service.

–ú–æ–¥–µ–ª—å Publish/Subscribe –æ–∑–Ω–∞—á–∞—î, —â–æ –æ–¥–∏–Ω publisher –º–æ–∂–µ –º–∞—Ç–∏ –±–∞–≥–∞—Ç–æ subscribers, —ñ –≤–æ–Ω–∏ –Ω–µ –∑–Ω–∞—é—Ç—å –æ–¥–∏–Ω –ø—Ä–æ –æ–¥–Ω–æ–≥–æ (loose coupling).

**5. –£ —á–æ–º—É —Ä—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ —á–µ—Ä–≥–æ—é —Ç–∞ —Ç–æ–ø—ñ–∫–æ–º?**

**–ß–µ—Ä–≥–∞ (Queue):**
- –ó–±–µ—Ä—ñ–≥–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö —Å–ø–æ–∂–∏–≤–∞—á—ñ–≤
- –ö–æ–∂–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –æ–¥–Ω–∏–º —Å–ø–æ–∂–∏–≤–∞—á–µ–º
- –í–∏–¥–∞–ª—è—î—Ç—å—Å—è –ø—ñ—Å–ª—è ACK
- –£ –Ω–∞—à—ñ–π —Å–∏—Å—Ç–µ–º—ñ: `order.created.product`, `order.created.notification`

**–¢–æ–ø—ñ–∫ (Topic Exchange):**
- –ú–∞—Ä—à—Ä—É—Ç–∏–∑—É—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —Ä—ñ–∑–Ω—ñ —á–µ—Ä–≥–∏ –∑–∞ routing key
- –ü—ñ–¥—Ç—Ä–∏–º—É—î wildcard –ø–∞—Ç–µ—Ä–Ω–∏ (`order.*`, `order.#`)
- –û–¥–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –º–æ–∂–µ –ø–æ—Ç—Ä–∞–ø–∏—Ç–∏ –≤ –∫—ñ–ª—å–∫–∞ —á–µ—Ä–≥
- –£ –Ω–∞—à—ñ–π —Å–∏—Å—Ç–µ–º—ñ: `orders_exchange` –∑ —Ç–∏–ø–æ–º `topic`

**–ü—Ä–∏–∫–ª–∞–¥ —Ä–æ–±–æ—Ç–∏:**
```
Order Service –ø—É–±–ª—ñ–∫—É—î –∑ routing_key="order.created"
   ‚Üì
orders_exchange (topic)
   ‚îú‚Üí order.created.product (Queue 1) ‚Üí Product Service
   ‚îî‚Üí order.created.notification (Queue 2) ‚Üí Notification Service
```

**6. –Ø–∫ –æ–±—Ä–æ–±–ª—è—Ç–∏ –ø–æ–º–∏–ª–∫–∏ —É –ø–æ–¥—ñ–π–Ω–æ-–æ—Ä—ñ—î–Ω—Ç–æ–≤–∞–Ω–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö?**

**–£ –Ω–∞—à—ñ–π —Å–∏—Å—Ç–µ–º—ñ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ:**

1. **Manual Acknowledgement:**
   - –£—Å–ø—ñ—à–Ω–∞ –æ–±—Ä–æ–±–∫–∞ ‚Üí `basic_ack()`
   - –ü–æ–º–∏–ª–∫–∞ ‚Üí `basic_nack(requeue=False)`

2. **–Ü–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å:**
   - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ `event_id` –≤ —Ç–∞–±–ª–∏—Ü—ñ `processed_events`
   - –Ø–∫—â–æ –ø–æ–¥—ñ—è –≤–∂–µ –æ–±—Ä–æ–±–ª–µ–Ω–∞ ‚Üí skip

3. **Prefetch Count:**
   - –û–±–º–µ–∂–µ–Ω–Ω—è –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (10)
   - –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—é consumer

**–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—ñ–¥—Ö–æ–¥–∏ (–¥–ª—è production):**

4. **Dead Letter Queue (DLQ):**
   - –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏, –π–¥—É—Ç—å —É DLQ
   - –†—É—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞ –æ–±—Ä–æ–±–∫–∞

5. **Retry –∑ Exponential Backoff:**
   - –ü–æ–≤—Ç–æ—Ä–Ω–∞ —Å–ø—Ä–æ–±–∞ —á–µ—Ä–µ–∑ 1s, 2s, 4s
   - –ü—ñ—Å–ª—è N —Å–ø—Ä–æ–± ‚Üí DLQ

6. **Circuit Breaker:**
   - –Ø–∫—â–æ –±–∞–≥–∞—Ç–æ –ø–æ–º–∏–ª–æ–∫ ‚Üí —Ç–∏–º—á–∞—Å–æ–≤–æ –ø—Ä–∏–ø–∏–Ω–∏—Ç–∏ –æ–±—Ä–æ–±–∫—É
   - –î–∞—Ç–∏ —á–∞—Å —Å–∏—Å—Ç–µ–º—ñ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏—Å—è

**7. –Ø–∫ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –º—ñ–∂—Å–µ—Ä–≤—ñ—Å–Ω—É –≤–∑–∞—î–º–æ–¥—ñ—é?**

**1. –†—É—á–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è:**
```bash
# –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
curl -X POST http://localhost:8002/orders -d '{...}'

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ stock –æ–Ω–æ–≤–∏–≤—Å—è
curl http://localhost:8001/products/1

# –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ª–æ–≥–∏ consumers
docker-compose logs -f product-service
```

**2. RabbitMQ Management UI:**
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ queues —Å—Ç–≤–æ—Ä–µ–Ω—ñ
- –ü–æ–±–∞—á–∏—Ç–∏ message rate
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ consumers –∞–∫—Ç–∏–≤–Ω—ñ

**3. Integration Tests:**
```python
def test_order_created_updates_stock():
    # 1. Create product with stock=10
    # 2. Create order with quantity=3
    # 3. Wait for event processing (sleep 2 sec)
    # 4. Assert product.stock == 7
```

**4. Contract Testing (Pact):**
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ñ–æ—Ä–º–∞—Ç –ø–æ–¥—ñ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –æ—á—ñ–∫—É–≤–∞–Ω–Ω—é consumer

**5. Chaos Testing:**
- –í–∏–º–∫–Ω—É—Ç–∏ Product Service ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ Order Service –ø—Ä–∞—Ü—é—î
- –í–∏–º–∫–Ω—É—Ç–∏ RabbitMQ ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ graceful degradation

---

## –î–û–î–ê–¢–û–ö –ê. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—ñ–≤

```
order-service/
‚îî‚îÄ‚îÄ app/
    ‚îî‚îÄ‚îÄ publishers/
        ‚îî‚îÄ‚îÄ event_publisher.py      

product-service/
‚îî‚îÄ‚îÄ app/
    ‚îú‚îÄ‚îÄ consumers/
    ‚îÇ   ‚îî‚îÄ‚îÄ order_consumer.py       
    ‚îú‚îÄ‚îÄ models/
    ‚îÇ   ‚îî‚îÄ‚îÄ product.py              
    ‚îî‚îÄ‚îÄ repositories/
        ‚îî‚îÄ‚îÄ product_repository.py   

notification-service/
‚îî‚îÄ‚îÄ app/
    ‚îú‚îÄ‚îÄ consumers/
    ‚îÇ   ‚îî‚îÄ‚îÄ order_consumer.py       
    ‚îî‚îÄ‚îÄ services/
        ‚îî‚îÄ‚îÄ notification_service.py 
```

## –î–û–î–ê–¢–û–ö –ë. –§–æ—Ä–º–∞—Ç –ø–æ–¥—ñ—ó

```json
{
  "event_type": "OrderCreated",
  "event_id": "550e8400-e29b-41d4-a716-446655440000",
  "event_version": "1.0",
  "timestamp": "2025-11-20T10:35:00.123Z",
  "source": "order-service",
  "data": {
    "order_id": 101,
    "product_id": 1,
    "product_name": "Test Laptop",
    "quantity": 5,
    "total_price": 5000.00,
    "customer_email": "test@example.com"
  }
}
```